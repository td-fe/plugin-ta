#!/bin/bash

ta:commit() {
  ta::prepare

  gpm commit

  ta::post_commit_merge
}

# ta::post_commit_merge 检查是否在配置的指定文件夹下，如果是则执行 mergeSprintDev
ta::post_commit_merge() {
  local folder_path="${PWD}/${0}" # 文件夹路径
  local old_ifs="$IFS"
  local ifs=","
  local folders=($PLUGIN_TA_FOLDERS)
  local ifs="$old_ifs"
  for folderName in ${folders[@]}; do
    local result=$(echo $folder_path | grep "${folderName}")
    if [ "$result" != "" ]; then
      ta::merge_remote
    fi
  done
}

# ta::merge_remote 如果是 feature，说明在开发功能，提交时可以自动 merge 远端 sprint_dev
ta::merge_remote() {
  local obr=$(git branch | grep "*")
  local br=${obr:2}
  local head=${br:0:7}

  if [ "$head" = "feature" ]; then
    log::info "[$(timestamp)] 符合分支名开头为 feature 的条件，同步 sprint_dev！"
    git fetch origin
    git merge origin/sprint_dev
    if [ "$?" != "0" ]; then
      log::error "[$(timestamp)] 同步 sprint_dev 失败，请手动解决冲突后再提交！"
      return 1
    fi

    log::success "[$(timestamp)] 同步 sprint_dev 成功！"
  fi
}

export -f ta:commit

export -f ta::post_commit_merge
export -f ta::merge_remote
